# å°è‚¡è·³ç©ºç¼ºå£äº¤æ˜“ç³»çµ± - å®Œæ•´åŸ·è¡Œæµç¨‹èˆ‡æ™‚é–“è¡¨

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°

æœ¬å°ˆæ¡ˆæ˜¯ä¸€å€‹**å…¨è‡ªå‹•åŒ–å°è‚¡è·³ç©ºç¼ºå£äº¤æ˜“ç›£æ§ç³»çµ±**ï¼Œçµåˆ FinLab é‡åŒ–åˆ†æèˆ‡ Shioaji API å³æ™‚è¡Œæƒ…ï¼Œé€é Docker å®¹å™¨åŒ–éƒ¨ç½²åœ¨é›²ç«¯ VM ä¸Šï¼Œå¯¦ç¾ 24/7 è‡ªå‹•åŒ–ç›£æ§èˆ‡ LINE é€šçŸ¥ã€‚

---

## â° å®Œæ•´æ™‚é–“è»¸ (Daily Timeline)

### ğŸŒ™ **å‡Œæ™¨ 00:00 - 08:30** | ç³»çµ±å¾…å‘½æœŸ
- **ç‹€æ…‹**: Docker å®¹å™¨é‹è¡Œä¸­ï¼Œç­‰å¾…è§¸ç™¼
- **å‹•ä½œ**: ç„¡
- **èªªæ˜**: ç³»çµ±è™•æ–¼å¾…å‘½ç‹€æ…‹ï¼Œç­‰å¾…ç›¤å‰æº–å‚™æ™‚é–“

---

### ğŸŒ… **08:30 - 08:55** | TSMC ADR æº¢åƒ¹ç›£æ§

#### â±ï¸ åŸ·è¡Œæ™‚é–“: `08:30` (å°åŒ—æ™‚é–“)
#### ğŸ“ åŸ·è¡Œæª”æ¡ˆ: `modules/tsm_premium.py`
#### ğŸ¯ åŸ·è¡Œæ¢ä»¶: `if now.time() < 09:00`

**åŠŸèƒ½èªªæ˜:**
- ç›£æ§ TSMC ADR (TSM) èˆ‡å°ç©é›» (2330) çš„æº¢åƒ¹é—œä¿‚
- æä¾›ç›¤å‰å¤§ç›¤æ–¹å‘æ€§å»ºè­°

**åŸ·è¡Œæ­¥é©Ÿ:**

1. **è³‡æ–™æŠ“å–** (08:30:00 - 08:30:30)
   - å¾ `yfinance` æŠ“å– TSM (ç¾è‚¡æ”¶ç›¤åƒ¹)
   - å¾ `yfinance` æŠ“å– TWD=X (ç¾å…ƒå…Œå°å¹£åŒ¯ç‡)
   - å¾ `finlab` æŠ“å– 2330 (å°ç©é›»æ˜¨æ”¶åƒ¹)

2. **æº¢åƒ¹è¨ˆç®—** (08:30:30 - 08:30:35)
   ```python
   æº¢åƒ¹ç‡ = ((TSM * TWD / 5) - 2330) / 2330 * 100
   ```

3. **å¸ƒæ—é€šé“åˆ†æ** (08:30:35 - 08:30:40)
   - è¨ˆç®—éå» 20 æ—¥æº¢åƒ¹ç‡çš„ç§»å‹•å¹³å‡ (MA20)
   - è¨ˆç®—æ¨™æº–å·® (STD20)
   - ä¸Šè»Œ = MA20 + 1 * STD20
   - ä¸‹è»Œ = MA20 - 1 * STD20

4. **è¨Šè™Ÿåˆ¤æ–·** (08:30:40 - 08:30:45)
   - **LONG è¨Šè™Ÿ**: æº¢åƒ¹ç‡ > ä¸Šè»Œ â†’ å»ºè­°åšå¤šå°è‚¡/2330
   - **SHORT è¨Šè™Ÿ**: æº¢åƒ¹ç‡ < ä¸‹è»Œ â†’ å»ºè­°æ”¾ç©ºå°è‚¡æœŸè²¨
   - **NEUTRAL**: åœ¨é€šé“å…§ â†’ è§€æœ›

5. **LINE é€šçŸ¥ç™¼é€** (08:30:45 - 08:31:00)
   - ç™¼é€ Flex Message æ ¼å¼çš„ç²¾ç¾é€šçŸ¥
   - åŒ…å«æº¢åƒ¹ç‡ã€å»ºè­°æ“ä½œã€é¢¨éšªé è­¦

**è¼¸å‡ºç¯„ä¾‹:**
```
TSMC ADR æº¢åƒ¹: +2.35% - å¤šé ­ä¿®æ­£è¨Šè™Ÿ (Long)
å»ºè­°è²·é€²å°è‚¡å¤§ç›¤/2330ã€‚æ•æ‰æº¢åƒ¹å›æ­¸å‹•èƒ½ï¼Œç›®æ¨™æŒæœ‰è‡³ T+10ã€‚
åœæåƒè€ƒ (MDD): å¤š -2.02% / ç©º -2.75%
```

---

### ğŸ“Š **08:55 - 09:00** | ç›¤å‰è³‡æ–™æº–å‚™ (Pre-Market)

#### â±ï¸ åŸ·è¡Œæ™‚é–“: `08:55` (å»ºè­°æ’ç¨‹æ™‚é–“)
#### ğŸ“ åŸ·è¡Œæª”æ¡ˆ: `pre_process.py`
#### ğŸ¯ ç›®æ¨™: ç¯©é¸å‡ºã€Œä½åŸºæœŸã€èˆ‡ã€Œå‡ç·šç³¾çµã€çš„æ½›åŠ›è‚¡

**åŸ·è¡Œæ­¥é©Ÿ:**

1. **é€£æ¥ FinLab** (08:55:00 - 08:55:05)
   ```python
   finlab.login(config.CONFIG["finlab_token"])
   ```

2. **æŠ“å–æ­·å²è³‡æ–™** (08:55:05 - 08:55:30)
   - æ”¶ç›¤åƒ¹ (`price:æ”¶ç›¤åƒ¹`)
   - æœ€é«˜åƒ¹ (`price:æœ€é«˜åƒ¹`)
   - æ™‚é–“ç¯„åœ: æœ€è¿‘ 60 å€‹äº¤æ˜“æ—¥

3. **ç­–ç•¥ 1: ä½åŸºæœŸç¯©é¸ (Bias Strategy)** (08:55:30 - 08:56:00)
   - è¨ˆç®— MA60 (60 æ—¥å‡ç·š)
   - è¨ˆç®—ä¹–é›¢ç‡: `bias = (close - ma60) / ma60`
   - æ’åº: ç”±ä½åˆ°é«˜
   - ç¯©é¸: å–**æœ€ä½ 60%** çš„è‚¡ç¥¨
   - é‚è¼¯: è‚¡åƒ¹é ä½æ–¼å‡ç·š = ä½åŸºæœŸ = åå½ˆæ½›åŠ›å¤§

4. **ç­–ç•¥ 2: å‡ç·šç³¾çµç¯©é¸ (MA Convergence)** (08:56:00 - 08:56:30)
   - è¨ˆç®— MA5, MA10, MA20
   - è¨ˆç®—ç³¾çµåº¦: `convergence = (max(MA) - min(MA)) / min(MA)`
   - ç¯©é¸: ç³¾çµåº¦ < 5% çš„è‚¡ç¥¨
   - é‚è¼¯: å‡ç·šç³¾çµ = å³å°‡çªç ´ = çˆ†ç™¼æ½›åŠ›

5. **åˆä½µå€™é¸æ¸…å–®** (08:56:30 - 08:57:00)
   - åˆä½µå…©å€‹ç­–ç•¥çš„çµæœ (å–è¯é›†)
   - æ¨™è¨˜æ¯æª”è‚¡ç¥¨çš„ç­–ç•¥ä¾†æº (`strategy_tag`)
     - `bias`: åƒ…ä¾†è‡ªä½åŸºæœŸç­–ç•¥
     - `ma_conv`: åƒ…ä¾†è‡ªå‡ç·šç³¾çµç­–ç•¥
     - `bias|ma_conv`: åŒæ™‚ç¬¦åˆå…©å€‹ç­–ç•¥

6. **å„²å­˜å€™é¸æ¸…å–®** (08:57:00 - 08:57:05)
   - è¼¸å‡ºæª”æ¡ˆ: `data/candidate_list.csv`
   - æ¬„ä½:
     - `stock_code`: è‚¡ç¥¨ä»£ç¢¼
     - `bias`: ä¹–é›¢ç‡æ•¸å€¼
     - `prev_high`: æ˜¨æ—¥æœ€é«˜åƒ¹ (ç”¨æ–¼è·³ç©ºåˆ¤æ–·)
     - `strategy_tag`: ç­–ç•¥æ¨™è¨˜
     - `data_date`: è³‡æ–™æ—¥æœŸ (YYYY-MM-DD)

**è¼¸å‡ºç¯„ä¾‹:**
```
ç¯©é¸å®Œæˆï¼å…± 450 æª”å€™é¸è‚¡ç¥¨
- ä½åŸºæœŸç­–ç•¥: 280 æª”
- å‡ç·šç³¾çµç­–ç•¥: 230 æª”
- é‡ç–Š: 60 æª”
è³‡æ–™æ—¥æœŸ: 2026-01-31
```

---

### ğŸš€ **09:00 - 09:01** | ç­‰å¾…é–‹ç›¤ç©©å®š

#### â±ï¸ åŸ·è¡Œæ™‚é–“: `09:00:00 - 09:01:00`
#### ğŸ“ åŸ·è¡Œæª”æ¡ˆ: `headless_monitor.py` (Line 142-147)
#### ğŸ¯ ç›®æ¨™: é¿å…é–‹ç›¤ç¬é–“è³‡æ–™ä¸ç©©å®š

**åŸ·è¡Œé‚è¼¯:**
```python
open_time = now.replace(hour=9, minute=1, second=0)
if now < open_time:
    wait_sec = (open_time - now).total_seconds()
    logger.info(f"Waiting {wait_sec:.0f}s for market open (09:01)...")
    time.sleep(wait_sec)
```

**èªªæ˜:**
- å°è‚¡ 09:00 é–‹ç›¤ï¼Œä½†ç¬é–“æ³¢å‹•å¤§ã€è³‡æ–™å¯èƒ½å»¶é²
- ç­‰å¾…è‡³ 09:01 ç¢ºä¿ API è³‡æ–™ç©©å®š

---

### ğŸ” **09:01 - 09:03** | é–‹ç›¤è·³ç©ºç¯©é¸ (Gap Filter)

#### â±ï¸ åŸ·è¡Œæ™‚é–“: `09:01:00 - 09:03:00`
#### ğŸ“ åŸ·è¡Œæª”æ¡ˆ: `headless_monitor.py` (Line 136-210)
#### ğŸ¯ ç›®æ¨™: å¾å€™é¸æ¸…å–®ä¸­ç¯©é¸å‡ºã€Œé–‹ç›¤è·³ç©º > 1%ã€çš„è‚¡ç¥¨

**åŸ·è¡Œæ­¥é©Ÿ:**

1. **è¼‰å…¥å€™é¸æ¸…å–®** (09:01:00 - 09:01:05)
   ```python
   candidates_df = pd.read_csv(config.CANDIDATE_LIST_PATH)
   all_codes = candidates_df['stock_code'].astype(str).tolist()
   ```

2. **è§£æåˆç´„ç‰©ä»¶** (09:01:05 - 09:01:30)
   - æ¨¡çµ„: `modules/contract_resolver.py`
   - å°‡è‚¡ç¥¨ä»£ç¢¼è½‰æ›ç‚º Shioaji Contract ç‰©ä»¶
   - æå–åˆç´„è³‡è¨Š (åç¨±ã€åƒè€ƒåƒ¹ã€æ˜¯å¦æœ‰è‚¡æœŸ)

3. **æŠ“å–å³æ™‚å¿«ç…§ (Snapshots)** (09:01:30 - 09:02:30)
   - æ¨¡çµ„: `modules/api_manager.py` â†’ `fetch_snapshots_parallel()`
   - ä½¿ç”¨å¤šåŸ·è¡Œç·’ä¸¦è¡ŒæŠ“å– (chunk_size=300, max_workers=2)
   - é‡è©¦æ©Ÿåˆ¶: æœ€å¤š 3 æ¬¡ï¼Œæ¯æ¬¡é–“éš” 30 ç§’
   - é©—è­‰è³‡æ–™æ—¥æœŸ: å¿…é ˆæ˜¯ä»Šæ—¥

4. **è·³ç©ºç¯©é¸é‚è¼¯** (09:02:30 - 09:03:00)
   ```python
   for snap in snapshots:
       ref_price = contract_info.get(code, {}).get("reference", 0.0)
       open_price = snap.open
       
       if ref_price > 0 and open_price > 0:
           gap_pct = (open_price - ref_price) / ref_price
           
           if gap_pct >= 0.01:  # 1%
               gap_list.append(code)
   ```

5. **è¨˜éŒ„ç¯©é¸çµæœ** (09:03:00)
   ```
   Gap Filter Result: 35 stocks found with Gap > 1%
     - [2330] ä½åŸºæœŸ
     - [2454] ä½åŸºæœŸ+å‡ç·šç³¾çµ
     - [6345] å‡ç·šç³¾çµ
   ```

**ç¯©é¸æ¢ä»¶:**
- é–‹ç›¤åƒ¹ â‰¥ æ˜¨æ”¶åƒ¹ * 1.01 (è·³ç©º 1%)
- è³‡æ–™å¿…é ˆæ˜¯ä»Šæ—¥ (é¿å…ä½¿ç”¨æ˜¨æ—¥èˆŠè³‡æ–™)

**è¼¸å‡º:**
- `gap_list`: ç¬¦åˆè·³ç©ºæ¢ä»¶çš„è‚¡ç¥¨ä»£ç¢¼åˆ—è¡¨
- æ­¤åˆ—è¡¨å°‡æˆç‚ºå¾ŒçºŒç›£æ§çš„**å›ºå®šæ¨£æœ¬**

---

### ğŸ“ˆ **09:03 - 13:30** | ç›¤ä¸­å³æ™‚ç›£æ§ (Intra-Day Monitoring)

#### â±ï¸ åŸ·è¡Œæ™‚é–“: `09:03:00 - 13:30:00` (æ¯ 60 ç§’ä¸€æ¬¡)
#### ğŸ“ åŸ·è¡Œæª”æ¡ˆ: `modules/monitor_loop.py`
#### ğŸ¯ ç›®æ¨™: æŒçºŒç›£æ§è·³ç©ºè‚¡ç¥¨ï¼Œç™¼ç¾ç¬¦åˆç­–ç•¥æ¢ä»¶æ™‚ç™¼é€ LINE é€šçŸ¥

**ç›£æ§è¿´åœˆ:**

```python
while True:
    now = datetime.datetime.now()
    if now.time() > datetime.time(13, 35):
        logger.info("Market closed. Daily run completed.")
        break
    
    # åŸ·è¡Œç›£æ§é‚è¼¯
    run_monitoring_iteration(...)
    
    # ç­‰å¾… 60 ç§’
    time.sleep(60)
```

**æ¯æ¬¡è¿­ä»£æ­¥é©Ÿ (60 ç§’é€±æœŸ):**

#### 1ï¸âƒ£ **æŠ“å–å³æ™‚å¿«ç…§** (00:00 - 00:15 ç§’)
```python
snapshots = fetch_snapshots_parallel(api, monitor_contracts, chunk_size=300)
```
- åƒ…æŠ“å– `gap_list` ä¸­çš„è‚¡ç¥¨ (å·²å„ªåŒ–ï¼Œä¸å†æŠ“å–å…¨éƒ¨å€™é¸è‚¡)
- è³‡æ–™åŒ…å«: open, high, low, close, volume, amount

#### 2ï¸âƒ£ **ç­–ç•¥æª¢æŸ¥** (00:15 - 00:45 ç§’)
- æ¨¡çµ„: `strategy.py` â†’ `check_criteria()`

**ä¸‰å¤§æ ¸å¿ƒæ¢ä»¶ (AND é‚è¼¯):**

```python
# æ¢ä»¶ 1: åš´æ ¼è·³ç©º (Strict Gap)
cond_gap = (low >= prev_high) AND (open > prev_high * 1.01)
```
- `low >= prev_high`: ä»Šæ—¥æœ€ä½åƒ¹ â‰¥ æ˜¨æ—¥æœ€é«˜åƒ¹ (å®Œå…¨è·³ç©ºï¼Œç„¡å›è£œ)
- `open > prev_high * 1.01`: é–‹ç›¤åƒ¹ > æ˜¨é«˜ * 1.01 (è·³ç©ºå¹…åº¦ > 1%)

```python
# æ¢ä»¶ 2: è‚¡åƒ¹ä½éš (P-Loc)
p_loc = (close - low) / (high - low)
cond_ploc = p_loc > 0.5
```
- P-Loc = è‚¡åƒ¹åœ¨ç•¶æ—¥å€é–“çš„ç›¸å°ä½ç½®
- P-Loc > 0.5: è‚¡åƒ¹ç¶­æŒåœ¨ä¸­é«˜æª”ï¼Œé¡¯ç¤ºå¼·å‹¢

```python
# æ¢ä»¶ 3: é‡èƒ½ (Volume & Amount)
cond_vol = (volume >= 500) AND (amount >= 10,000,000)
```
- æˆäº¤é‡ â‰¥ 500 å¼µ
- æˆäº¤é‡‘é¡ â‰¥ 1,000 è¬å…ƒ
- ç¢ºä¿æœ‰è¶³å¤ æµå‹•æ€§

**æœ€çµ‚åˆ¤æ–·:**
```python
is_active = cond_gap AND cond_ploc AND cond_vol
```

#### 3ï¸âƒ£ **åˆ†é¡é‚è¼¯** (00:45 - 00:55 ç§’)

ç³»çµ±å°‡è‚¡ç¥¨åˆ†ç‚ºä¸‰å€‹å€åŸŸ:

**ğŸ”¥ å¼·å‹¢å€ (Active Matches)**
- æ¢ä»¶: `is_active == True` (ä¸‰å€‹æ¢ä»¶å…¨éƒ¨ç¬¦åˆ)
- å‹•ä½œ: 
  - åŠ å…¥ `active_df` (å¼·å‹¢å€è¡¨æ ¼)
  - ç™¼é€ LINE é€šçŸ¥ (åƒ…é¦–æ¬¡é€²å…¥æ™‚)
  - è¨˜éŒ„åˆ° `triggered_history` (æ­·å²è§¸ç™¼è¨˜éŒ„)

**ğŸ‘€ è§€å¯Ÿå€ (Watchlist)**
- æ¢ä»¶: æ›¾ç¶“é€²å…¥å¼·å‹¢å€ï¼Œä½†ç›®å‰ä¸ç¬¦åˆæ¢ä»¶
- å‹•ä½œ:
  - åŠ å…¥ `watchlist_df` (è§€å¯Ÿå€è¡¨æ ¼)
  - æ¨™è¨˜ã€Œ(è½‰å¼±è§€å¯Ÿ)ã€
  - ä¸ç™¼é€é€šçŸ¥

**ğŸ“Š è·³ç©ºæ±  (Gap Monitoring Pool)**
- æ¢ä»¶: æ‰€æœ‰ç¬¦åˆé–‹ç›¤è·³ç©º > 1% çš„è‚¡ç¥¨ (å›ºå®šæ¨£æœ¬)
- å‹•ä½œ:
  - åŠ å…¥ `gap_df` (è·³ç©ºæ± è¡¨æ ¼)
  - åƒ…é¡¯ç¤ºï¼Œä¸ç™¼é€é€šçŸ¥

#### 4ï¸âƒ£ **LINE é€šçŸ¥ç™¼é€** (00:55 - 01:00 ç§’)
- æ¨¡çµ„: `line_notifier.py` â†’ `notify_signal()`
- è§¸ç™¼æ¢ä»¶: è‚¡ç¥¨**é¦–æ¬¡é€²å…¥**å¼·å‹¢å€
- é˜²é‡è¤‡æ©Ÿåˆ¶: ä½¿ç”¨ `triggered_history` è¨˜éŒ„å·²é€šçŸ¥çš„è‚¡ç¥¨

**é€šçŸ¥å…§å®¹:**
```
ğŸš€ å¼·å‹¢è·³ç©ºè¨Šè™Ÿ

ä»£ç¢¼: 2330 å°ç©é›»
ç¾åƒ¹: 685 å…ƒ
è·³ç©º: +2.35%
P-Loc: 0.87 (å¼·å‹¢)
é‡èƒ½: 12,500 å¼µ / 8.5 å„„å…ƒ
ç‰¹å¾µ: âš¡æœ‰è‚¡æœŸ ğŸ”¥S6_æ¥µå¼·å‹¢
```

#### 5ï¸âƒ£ **ç­‰å¾…ä¸‹ä¸€æ¬¡æƒæ** (01:00 - 60:00 ç§’)
```python
time.sleep(60)
```

---

### ğŸŒ™ **13:30 - 13:35** | æ”¶ç›¤å¾Œè™•ç†

#### â±ï¸ åŸ·è¡Œæ™‚é–“: `13:30:00 - 13:35:00`
#### ğŸ“ åŸ·è¡Œæª”æ¡ˆ: `headless_monitor.py` (Line 222-224)

**åŸ·è¡Œé‚è¼¯:**
```python
while True:
    now = datetime.datetime.now()
    if now.time() > datetime.time(13, 35):
        logger.info("Market closed. Daily run completed.")
        break
```

**å‹•ä½œ:**
- åœæ­¢ç›£æ§è¿´åœˆ
- è¨˜éŒ„æ—¥èªŒ: "Market closed. Daily run completed."
- å®¹å™¨ç¹¼çºŒé‹è¡Œï¼Œç­‰å¾…æ˜æ—¥ 08:30

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### éƒ¨ç½²æ–¹å¼

**Docker å®¹å™¨åŒ–éƒ¨ç½²:**
```dockerfile
FROM python:3.9-slim
ENV TZ=Asia/Taipei
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["python", "headless_monitor.py"]
```

**å•Ÿå‹•å‘½ä»¤:**
```bash
docker run -d \
  --name gaptrading \
  --restart unless-stopped \
  -e SHIOAJI_API_KEY="your_key" \
  -e SHIOAJI_SECRET_KEY="your_secret" \
  -e LINE_TOKEN="your_line_token" \
  -e LINE_USER_ID="your_user_id" \
  -e FINLAB_TOKEN="your_finlab_token" \
  gaptrading:latest
```

### åŸ·è¡Œæ¨¡å¼

**1. Headless Mode (ç”Ÿç”¢ç’°å¢ƒ)**
- æª”æ¡ˆ: `headless_monitor.py`
- ç”¨é€”: Docker å®¹å™¨è‡ªå‹•åŒ–åŸ·è¡Œ
- ç‰¹è‰²: ç„¡ UIï¼Œç´”å¾Œå°é‹è¡Œï¼ŒLOG è¼¸å‡ºåˆ° stdout

**2. Streamlit UI Mode (é–‹ç™¼/æ¸¬è©¦)**
- æª”æ¡ˆ: `app.py`
- ç”¨é€”: æœ¬åœ°é–‹ç™¼ã€æ‰‹å‹•æ¸¬è©¦
- å•Ÿå‹•: `streamlit run app.py`
- ç‰¹è‰²: è¦–è¦ºåŒ–ä»‹é¢ï¼Œå³æ™‚ç›£æ§é¢æ¿

---

## ğŸ“Š è³‡æ–™æµå‘åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      08:30 - TSMC ADR ç›£æ§                   â”‚
â”‚  yfinance (TSM, TWD) + finlab (2330) â†’ æº¢åƒ¹è¨ˆç®— â†’ LINE é€šçŸ¥  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      08:55 - ç›¤å‰æº–å‚™                        â”‚
â”‚   finlab (æ”¶ç›¤åƒ¹, æœ€é«˜åƒ¹) â†’ ä½åŸºæœŸç¯©é¸ + å‡ç·šç³¾çµç¯©é¸        â”‚
â”‚                    â†“                                         â”‚
â”‚            candidate_list.csv (450 æª”)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      09:01 - é–‹ç›¤è·³ç©ºç¯©é¸                    â”‚
â”‚   Shioaji API (Snapshots) â†’ è·³ç©º > 1% ç¯©é¸                  â”‚
â”‚                    â†“                                         â”‚
â”‚              gap_list (35 æª”) â† å›ºå®šç›£æ§æ¨£æœ¬                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  09:03 - 13:30 ç›¤ä¸­ç›£æ§ (æ¯ 60 ç§’)           â”‚
â”‚   Shioaji API (Snapshots) â†’ ç­–ç•¥æª¢æŸ¥ (Gap + P-Loc + Vol)    â”‚
â”‚                    â†“                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  å¼·å‹¢å€ (5)  â”‚  è§€å¯Ÿå€ (8)  â”‚  è·³ç©ºæ±  (35) â”‚            â”‚
â”‚   â”‚  LINE é€šçŸ¥   â”‚  æŒçºŒè¿½è¹¤    â”‚  å›ºå®šæ¨£æœ¬    â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ é—œéµé…ç½®åƒæ•¸

### `config.py` åƒæ•¸èªªæ˜

```python
# è·³ç©ºç¯©é¸
GAP_THRESHOLD = 0.01  # 1% (é–‹ç›¤è·³ç©ºé–€æª»)

# ç­–ç•¥æ¢ä»¶
P_LOC_THRESHOLD = 0.5  # è‚¡åƒ¹ä½éšé–€æª»
MIN_VOLUME_SHEETS = 500  # æœ€ä½æˆäº¤é‡ (å¼µ)
MIN_AMOUNT_TWD = 10_000_000  # æœ€ä½æˆäº¤é‡‘é¡ (å…ƒ)

# ç›¤å‰ç¯©é¸
BIAS_WINDOW = 60  # ä¹–é›¢ç‡è¨ˆç®—é€±æœŸ (æ—¥)
BIAS_PERCENTILE = 0.60  # ä½åŸºæœŸç¯©é¸æ¯”ä¾‹ (å–æœ€ä½ 60%)
MA_CONVERGENCE_THRESHOLD = 0.05  # å‡ç·šç³¾çµé–€æª» (5%)
```

---

## ğŸ“ å°ˆæ¡ˆæª”æ¡ˆçµæ§‹

```
!Gaptrading/
â”œâ”€â”€ app.py                      # Streamlit UI ä¸»ç¨‹å¼
â”œâ”€â”€ headless_monitor.py         # Docker è‡ªå‹•åŒ–ä¸»ç¨‹å¼ â­
â”œâ”€â”€ config.py                   # é…ç½®åƒæ•¸
â”œâ”€â”€ strategy.py                 # ç­–ç•¥é‚è¼¯ (ä¸‰å¤§æ¢ä»¶)
â”œâ”€â”€ pre_process.py              # ç›¤å‰ç¯©é¸ (FinLab)
â”œâ”€â”€ line_notifier.py            # LINE é€šçŸ¥æ¨¡çµ„
â”œâ”€â”€ Dockerfile                  # Docker å®¹å™¨é…ç½®
â”œâ”€â”€ requirements.txt            # Python ä¾è³´å¥—ä»¶
â”œâ”€â”€ login.json                  # API æ†‘è­‰ (ä¸ä¸Šå‚³ Git)
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ tsm_premium.py          # TSMC ADR æº¢åƒ¹ç›£æ§ â­
â”‚   â”œâ”€â”€ api_manager.py          # Shioaji API ç®¡ç†
â”‚   â”œâ”€â”€ contract_resolver.py    # åˆç´„è§£æ
â”‚   â”œâ”€â”€ gap_filter.py           # è·³ç©ºç¯©é¸
â”‚   â”œâ”€â”€ monitor_loop.py         # ç›£æ§è¿´åœˆ â­
â”‚   â””â”€â”€ ui_components.py        # UI å…ƒä»¶
â”‚
â””â”€â”€ data/
    â””â”€â”€ candidate_list.csv      # ç›¤å‰å€™é¸æ¸…å–® (æ¯æ—¥æ›´æ–°)
```

---

## ğŸ¯ ç­–ç•¥é‚è¼¯ç¸½çµ

### ç›¤å‰ç¯©é¸ (Pre-Market)
1. **ä½åŸºæœŸç­–ç•¥**: ä¹–é›¢ç‡æœ€ä½ 60% â†’ åå½ˆæ½›åŠ›
2. **å‡ç·šç³¾çµç­–ç•¥**: MA5/MA10/MA20 ç³¾çµåº¦ < 5% â†’ çªç ´æ½›åŠ›

### é–‹ç›¤ç¯©é¸ (Gap Filter)
- é–‹ç›¤è·³ç©º > 1% â†’ ç¸®å°ç›£æ§ç¯„åœ

### ç›¤ä¸­ç›£æ§ (Intra-Day)
**ä¸‰å¤§æ ¸å¿ƒæ¢ä»¶ (AND):**
1. **åš´æ ¼è·³ç©º**: Low â‰¥ PrevHigh AND Open > PrevHigh * 1.01
2. **è‚¡åƒ¹ä½éš**: P-Loc > 0.5 (ç¶­æŒä¸­é«˜æª”)
3. **é‡èƒ½ç¢ºèª**: Vol â‰¥ 500 å¼µ AND Amt â‰¥ 1,000 è¬

**ç‰¹å¾µåŠ åˆ†:**
- âš¡æœ‰è‚¡æœŸ: æµå‹•æ€§ä½³
- ğŸ”¥S6_æ¥µå¼·å‹¢: P-Loc â‰¥ 0.95 (è‚¡åƒ¹åœ¨ç•¶æ—¥æœ€é«˜é»é™„è¿‘)

---

## ğŸ“± LINE é€šçŸ¥æ©Ÿåˆ¶

### é€šçŸ¥æ™‚æ©Ÿ
- **TSMC ADR**: æ¯æ—¥ 08:30 ç™¼é€ä¸€æ¬¡ (ç›¤å‰æ–¹å‘å»ºè­°)
- **è·³ç©ºè¨Šè™Ÿ**: è‚¡ç¥¨**é¦–æ¬¡é€²å…¥**å¼·å‹¢å€æ™‚ç™¼é€

### é˜²é‡è¤‡æ©Ÿåˆ¶
```python
if is_active:
    if code not in session_state.triggered_history:
        notifier.notify_signal(...)  # ç™¼é€é€šçŸ¥
        session_state.triggered_history.add(code)  # è¨˜éŒ„å·²é€šçŸ¥
```

### é€šçŸ¥æ ¼å¼
- TSMC ADR: Flex Message (ç²¾ç¾å¡ç‰‡å¼)
- è·³ç©ºè¨Šè™Ÿ: Text Message (ç°¡æ½”æ–‡å­—)

---

## ğŸš€ å¿«é€Ÿå•Ÿå‹•æŒ‡å—

### æœ¬åœ°æ¸¬è©¦ (Streamlit UI)
```bash
# 1. å®‰è£ä¾è³´
pip install -r requirements.txt

# 2. è¨­å®š login.json
{
  "api_key": "your_shioaji_api_key",
  "secret_key": "your_shioaji_secret_key",
  "line_channel_access_token": "your_line_token",
  "line_user_id": "your_line_user_id",
  "finlab_token": "your_finlab_token"
}

# 3. å•Ÿå‹• UI
streamlit run app.py
```

### ç”Ÿç”¢éƒ¨ç½² (Docker)
```bash
# 1. å»ºç½®æ˜ åƒæª”
docker build -t gaptrading:latest .

# 2. å•Ÿå‹•å®¹å™¨
docker run -d \
  --name gaptrading \
  --restart unless-stopped \
  -e SHIOAJI_API_KEY="your_key" \
  -e SHIOAJI_SECRET_KEY="your_secret" \
  -e LINE_TOKEN="your_line_token" \
  -e LINE_USER_ID="your_user_id" \
  -e FINLAB_TOKEN="your_finlab_token" \
  gaptrading:latest

# 3. æŸ¥çœ‹æ—¥èªŒ
docker logs -f gaptrading
```

---

## ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–

### å·²å¯¦æ–½å„ªåŒ–
1. **ä¸¦è¡ŒæŠ“å–**: `fetch_snapshots_parallel()` ä½¿ç”¨å¤šåŸ·è¡Œç·’
2. **æ¨£æœ¬ç¸®æ¸›**: é–‹ç›¤ç¯©é¸å¾Œåƒ…ç›£æ§è·³ç©ºè‚¡ç¥¨ (450 â†’ 35 æª”)
3. **åˆç´„å¿«å–**: åƒ…åœ¨é–‹ç›¤æ™‚è§£æä¸€æ¬¡åˆç´„ç‰©ä»¶
4. **é˜²é‡è¤‡é€šçŸ¥**: ä½¿ç”¨ `triggered_history` é¿å…é‡è¤‡ç™¼é€

### è³‡æºæ¶ˆè€—
- **è¨˜æ†¶é«”**: ~200 MB (Docker å®¹å™¨)
- **CPU**: ~5% (ç›£æ§æœŸé–“)
- **ç¶²è·¯**: ~10 MB/day (API è«‹æ±‚)

---

## âš ï¸ æ³¨æ„äº‹é …

### è³‡æ–™æ™‚æ•ˆæ€§
- FinLab è³‡æ–™: T-1 (æ˜¨æ—¥æ”¶ç›¤å¾Œæ›´æ–°)
- Shioaji è³‡æ–™: å³æ™‚ (å»¶é² < 1 ç§’)

### å‡æ—¥è™•ç†
- éäº¤æ˜“æ—¥: ç›¤å‰ç¯©é¸æœƒä½¿ç”¨æœ€è¿‘ä¸€å€‹äº¤æ˜“æ—¥çš„è³‡æ–™
- å»ºè­°: åœ¨ `pre_process.py` ä¸­æª¢æŸ¥ `data_date` æ˜¯å¦ç‚ºä»Šæ—¥

### API é™åˆ¶
- Shioaji: å–®ä¸€å¸³è™Ÿæœ€å¤š 3 å€‹é€£ç·š
- FinLab: å…è²»ç‰ˆæœ‰è«‹æ±‚æ¬¡æ•¸é™åˆ¶
- LINE Messaging API: å…è²»ç‰ˆæ¯æœˆ 500 å‰‡è¨Šæ¯

---

## ğŸ“ æ•…éšœæ’é™¤

### å•é¡Œ 1: åˆç´„ç‰©ä»¶ç‚ºç©º
**ç—‡ç‹€**: `No contracts resolved`
**åŸå› **: Shioaji API åˆç´„ä¸‹è¼‰æœªå®Œæˆ
**è§£æ±º**:
```python
api.fetch_contracts(contract_download=True)
time.sleep(60)  # ç­‰å¾…åˆç´„ä¸‹è¼‰
```

### å•é¡Œ 2: è³‡æ–™æ—¥æœŸä¸ç¬¦
**ç—‡ç‹€**: `ts_date != target_date_str`
**åŸå› **: æŠ“å–åˆ°æ˜¨æ—¥èˆŠè³‡æ–™
**è§£æ±º**: å¢åŠ é‡è©¦æ¬¡æ•¸ï¼Œå»¶é•·ç­‰å¾…æ™‚é–“è‡³ 09:01

### å•é¡Œ 3: LINE é€šçŸ¥æœªç™¼é€
**ç—‡ç‹€**: ç„¡é€šçŸ¥ä½†æœ‰å¼·å‹¢è‚¡
**åŸå› **: `triggered_history` å·²è¨˜éŒ„
**è§£æ±º**: é‡å•Ÿå®¹å™¨æ¸…ç©º session state

---

## ğŸ“ ç‰ˆæœ¬æ­·å²

### v2.0 (2026-01-31)
- âœ… æ–°å¢ TSMC ADR æº¢åƒ¹ç›£æ§
- âœ… æ–°å¢å‡ç·šç³¾çµç­–ç•¥
- âœ… å„ªåŒ–ç›£æ§æ¨£æœ¬ (åƒ…ç›£æ§è·³ç©ºè‚¡)
- âŒ ç§»é™¤æ¨¡æ“¬å›æ¸¬åŠŸèƒ½ (`simulation_runner.py`)

### v1.0 (2026-01-26)
- âœ… åŸºç¤è·³ç©ºç›£æ§åŠŸèƒ½
- âœ… Docker å®¹å™¨åŒ–éƒ¨ç½²
- âœ… LINE é€šçŸ¥æ•´åˆ

---

## ğŸ“ å­¸ç¿’è³‡æº

### FinLab æ–‡ä»¶
- å®˜ç¶²: https://ai.finlab.tw/
- API æ–‡ä»¶: https://doc.finlab.tw/

### Shioaji æ–‡ä»¶
- GitHub: https://github.com/Sinotrade/Shioaji
- API æ–‡ä»¶: https://sinotrade.github.io/

### LINE Messaging API
- å®˜ç¶²: https://developers.line.biz/

---

**æœ€å¾Œæ›´æ–°**: 2026-01-31  
**ç¶­è­·è€…**: Yuan Chen  
**å°ˆæ¡ˆç‹€æ…‹**: âœ… ç”Ÿç”¢é‹è¡Œä¸­
